<!DOCTYPE html>

<html>
<head>
  <title>TypeChecker.hs</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="CTT.html">
                  CTT.hs
                </a>
              
                
                <a class="source" href="Connections.html">
                  Connections.hs
                </a>
              
                
                <a class="source" href="Eval.html">
                  Eval.hs
                </a>
              
                
                <a class="source" href="Main.html">
                  Main.hs
                </a>
              
                
                <a class="source" href="Resolver.html">
                  Resolver.hs
                </a>
              
                
                <a class="source" href="Setup.html">
                  Setup.hs
                </a>
              
                
                <a class="source" href="TypeChecker.html">
                  TypeChecker.hs
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>TypeChecker.hs</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">{-# LANGUAGE TupleSections #-}</span>
<span class="hljs-keyword">module</span> TypeChecker <span class="hljs-keyword">where</span>

<span class="hljs-keyword">import</span> Control.Applicative <span class="hljs-keyword">hiding</span> (<span class="hljs-title">empty</span>)
<span class="hljs-keyword">import</span> Control.Monad
<span class="hljs-keyword">import</span> Control.Monad.Except
<span class="hljs-keyword">import</span> Control.Monad.Reader
<span class="hljs-keyword">import</span> Data.Map (<span class="hljs-type">Map</span>,(!),mapWithKey,assocs,filterWithKey,elems,keys
                ,intersection,intersectionWith,intersectionWithKey
                ,toList,fromList)
<span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Data.Map <span class="hljs-keyword">as</span> Map
<span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Data.Traversable <span class="hljs-keyword">as</span> T

<span class="hljs-keyword">import</span> Connections
<span class="hljs-keyword">import</span> CTT
<span class="hljs-keyword">import</span> Eval</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>Type checking monad</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Typing</span> a = <span class="hljs-type">ReaderT</span> <span class="hljs-type">TEnv</span> (<span class="hljs-type">ExceptT</span> <span class="hljs-type">String</span> <span class="hljs-type">IO</span>) a</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>Environment for type checker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">TEnv</span> =</span>
  <span class="hljs-type">TEnv</span> { names   :: [<span class="hljs-type">String</span>] <span class="hljs-comment">-- generated names</span>
       , indent  :: <span class="hljs-type">Int</span>
       , env     :: <span class="hljs-type">Env</span>
       , verbose :: <span class="hljs-type">Bool</span>  <span class="hljs-comment">-- Should it be verbose and print what it typechecks?</span>
       } <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Eq</span>)

<span class="hljs-title">verboseEnv</span>, silentEnv :: <span class="hljs-type">TEnv</span>
<span class="hljs-title">verboseEnv</span> = <span class="hljs-type">TEnv</span> [] <span class="hljs-number">0</span> emptyEnv <span class="hljs-type">True</span>
<span class="hljs-title">silentEnv</span>  = <span class="hljs-type">TEnv</span> [] <span class="hljs-number">0</span> emptyEnv <span class="hljs-type">False</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Trace function that depends on the verbosity flag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">trace</span> :: <span class="hljs-type">String</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">trace</span> s = <span class="hljs-keyword">do</span>
  b &lt;- asks verbose
  when b $ liftIO (putStrLn s)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <hr>
<p>| Functions for running computations in the type checker monad</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-title">runTyping</span> :: <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">Typing</span> a -&gt; <span class="hljs-type">IO</span> (<span class="hljs-type">Either</span> <span class="hljs-type">String</span> a)
<span class="hljs-title">runTyping</span> env t = runExceptT $ runReaderT t env

<span class="hljs-title">runDecls</span> :: <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">Decls</span> -&gt; <span class="hljs-type">IO</span> (<span class="hljs-type">Either</span> <span class="hljs-type">String</span> <span class="hljs-type">TEnv</span>)
<span class="hljs-title">runDecls</span> tenv d = runTyping tenv $ <span class="hljs-keyword">do</span>
  checkDecls d
  return $ addDecls d tenv

<span class="hljs-title">runDeclss</span> :: <span class="hljs-type">TEnv</span> -&gt; [<span class="hljs-type">Decls</span>] -&gt; <span class="hljs-type">IO</span> (<span class="hljs-type">Maybe</span> <span class="hljs-type">String</span>,<span class="hljs-type">TEnv</span>)
<span class="hljs-title">runDeclss</span> tenv []     = return (<span class="hljs-type">Nothing</span>, tenv)
<span class="hljs-title">runDeclss</span> tenv (d:ds) = <span class="hljs-keyword">do</span>
  x &lt;- runDecls tenv d
  <span class="hljs-keyword">case</span> x <span class="hljs-keyword">of</span>
    <span class="hljs-type">Right</span> tenv&#x27; -&gt; runDeclss tenv&#x27; ds
    <span class="hljs-type">Left</span> s      -&gt; return (<span class="hljs-type">Just</span> s, tenv)

<span class="hljs-title">runInfer</span> :: <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">IO</span> (<span class="hljs-type">Either</span> <span class="hljs-type">String</span> <span class="hljs-type">Val</span>)
<span class="hljs-title">runInfer</span> lenv e = runTyping lenv (infer e)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <hr>
<p>| Modifiers for the environment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-title">addTypeVal</span> :: (<span class="hljs-type">Ident</span>,<span class="hljs-type">Val</span>) -&gt; <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">TEnv</span>
<span class="hljs-title">addTypeVal</span> (x,a) (<span class="hljs-type">TEnv</span> ns ind rho v) =
  <span class="hljs-keyword">let</span> w@(<span class="hljs-type">VVar</span> n _) = mkVarNice ns x a
  <span class="hljs-keyword">in</span> <span class="hljs-type">TEnv</span> (n:ns) ind (upd (x,w) rho) v

<span class="hljs-title">addSub</span> :: (<span class="hljs-type">Name</span>,<span class="hljs-type">Formula</span>) -&gt; <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">TEnv</span>
<span class="hljs-title">addSub</span> iphi (<span class="hljs-type">TEnv</span> ns ind rho v) = <span class="hljs-type">TEnv</span> ns ind (sub iphi rho) v

<span class="hljs-title">addSubs</span> :: [(<span class="hljs-type">Name</span>,<span class="hljs-type">Formula</span>)] -&gt; <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">TEnv</span>
<span class="hljs-title">addSubs</span> = flip $ foldr addSub

<span class="hljs-title">addType</span> :: (<span class="hljs-type">Ident</span>,<span class="hljs-type">Ter</span>) -&gt; <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">TEnv</span>
<span class="hljs-title">addType</span> (x,a) tenv@(<span class="hljs-type">TEnv</span> _ _ rho _) = addTypeVal (x,eval rho a) tenv

<span class="hljs-title">addBranch</span> :: [(<span class="hljs-type">Ident</span>,<span class="hljs-type">Val</span>)] -&gt; <span class="hljs-type">Env</span> -&gt; <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">TEnv</span>
<span class="hljs-title">addBranch</span> nvs env (<span class="hljs-type">TEnv</span> ns ind rho v) =
  <span class="hljs-type">TEnv</span> ([n | (_,<span class="hljs-type">VVar</span> n _) &lt;- nvs] ++ ns) ind (upds nvs rho) v

<span class="hljs-title">addDecls</span> :: <span class="hljs-type">Decls</span> -&gt; <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">TEnv</span>
<span class="hljs-title">addDecls</span> d (<span class="hljs-type">TEnv</span> ns ind rho v) = <span class="hljs-type">TEnv</span> ns ind (def d rho) v

<span class="hljs-title">addTele</span> :: <span class="hljs-type">Tele</span> -&gt; <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">TEnv</span>
<span class="hljs-title">addTele</span> xas lenv = foldl (flip addType) lenv xas

<span class="hljs-title">faceEnv</span> :: <span class="hljs-type">Face</span> -&gt; <span class="hljs-type">TEnv</span> -&gt; <span class="hljs-type">TEnv</span>
<span class="hljs-title">faceEnv</span> alpha tenv = tenv{env=env tenv `face` alpha}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <hr>
<p>| Various useful functions</p>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>Extract the type of a label as a closure</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">getLblType</span> :: <span class="hljs-type">LIdent</span> -&gt; <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Typing</span> (<span class="hljs-type">Tele</span>, <span class="hljs-type">Env</span>)
<span class="hljs-title">getLblType</span> c (<span class="hljs-type">Ter</span> (<span class="hljs-type">Sum</span> _ _ cas) r) = <span class="hljs-keyword">case</span> lookupLabel c cas <span class="hljs-keyword">of</span>
  <span class="hljs-type">Just</span> <span class="hljs-keyword">as</span> -&gt; return (<span class="hljs-keyword">as</span>,r)
  <span class="hljs-type">Nothing</span> -&gt; throwError (<span class="hljs-string">&quot;getLblType: &quot;</span> ++ show c ++ <span class="hljs-string">&quot; in &quot;</span> ++ show cas)
<span class="hljs-title">getLblType</span> c (<span class="hljs-type">Ter</span> (<span class="hljs-type">HSum</span> _ _ cas) r) = <span class="hljs-keyword">case</span> lookupLabel c cas <span class="hljs-keyword">of</span>
  <span class="hljs-type">Just</span> <span class="hljs-keyword">as</span> -&gt; return (<span class="hljs-keyword">as</span>,r)
  <span class="hljs-type">Nothing</span> -&gt; throwError (<span class="hljs-string">&quot;getLblType: &quot;</span> ++ show c ++ <span class="hljs-string">&quot; in &quot;</span> ++ show cas)
<span class="hljs-title">getLblType</span> c u = throwError (<span class="hljs-string">&quot;expected a data type for the constructor &quot;</span>
                             ++ c ++ <span class="hljs-string">&quot; but got &quot;</span> ++ show u)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>Monadic version of unless</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">unlessM</span> :: <span class="hljs-type">Monad</span> m =&gt; m <span class="hljs-type">Bool</span> -&gt; m () -&gt; m ()
<span class="hljs-title">unlessM</span> mb x = mb &gt;&gt;= flip unless x

<span class="hljs-title">mkVars</span> :: [<span class="hljs-type">String</span>] -&gt; <span class="hljs-type">Tele</span> -&gt; <span class="hljs-type">Env</span> -&gt; [(<span class="hljs-type">Ident</span>,<span class="hljs-type">Val</span>)]
<span class="hljs-title">mkVars</span> _ [] _           = []
<span class="hljs-title">mkVars</span> ns ((x,a):xas) nu =
  <span class="hljs-keyword">let</span> w@(<span class="hljs-type">VVar</span> n _) = mkVarNice ns x (eval nu a)
  <span class="hljs-keyword">in</span> (x,w) : mkVars (n:ns) xas (upd (x,w) nu)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>Test if two values are convertible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>(===) :: <span class="hljs-type">Convertible</span> a =&gt; a -&gt; a -&gt; <span class="hljs-type">Typing</span> <span class="hljs-type">Bool</span>
<span class="hljs-title">u</span> === v = conv &lt;$&gt; asks names &lt;*&gt; pure u &lt;*&gt; pure v</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>eval in the typing monad</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">evalTyping</span> :: <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> <span class="hljs-type">Val</span>
<span class="hljs-title">evalTyping</span> t = eval &lt;$&gt; asks env &lt;*&gt; pure t</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <hr>
<p>| The bidirectional type checker</p>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>Check that t has type a</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">check</span> :: <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">check</span> a t = <span class="hljs-keyword">case</span> (a,t) <span class="hljs-keyword">of</span>
  (_,<span class="hljs-type">Undef</span>{}) -&gt; return ()
  (_,<span class="hljs-type">Hole</span> l)  -&gt; <span class="hljs-keyword">do</span>
      rho &lt;- asks env
      <span class="hljs-keyword">let</span> e = unlines (reverse (contextOfEnv rho))
      ns &lt;- asks names
      trace $ <span class="hljs-string">&quot;\nHole at &quot;</span> ++ show l ++ <span class="hljs-string">&quot;:\n\n&quot;</span> ++
              e ++ replicate <span class="hljs-number">80</span> &#x27;-&#x27; ++ <span class="hljs-string">&quot;\n&quot;</span> ++ show (normal ns a)  ++ <span class="hljs-string">&quot;\n&quot;</span>
  (_,<span class="hljs-type">Con</span> c es) -&gt; <span class="hljs-keyword">do</span>
    (bs,nu) &lt;- getLblType c a
    checks (bs,nu) es
  (<span class="hljs-type">VU</span>,<span class="hljs-type">Pi</span> f)       -&gt; checkFam f
  (<span class="hljs-type">VU</span>,<span class="hljs-type">Sigma</span> f)    -&gt; checkFam f
  (<span class="hljs-type">VU</span>,<span class="hljs-type">Sum</span> _ _ bs) -&gt; forM_ bs $ \lbl -&gt; <span class="hljs-keyword">case</span> lbl <span class="hljs-keyword">of</span>
    <span class="hljs-type">OLabel</span> _ tele -&gt; checkTele tele
    <span class="hljs-type">PLabel</span> _ tele is ts -&gt;
      throwError $ <span class="hljs-string">&quot;check: no path constructor allowed in &quot;</span> ++ show t
  (<span class="hljs-type">VU</span>,<span class="hljs-type">HSum</span> _ _ bs) -&gt; forM_ bs $ \lbl -&gt; <span class="hljs-keyword">case</span> lbl <span class="hljs-keyword">of</span>
    <span class="hljs-type">OLabel</span> _ tele -&gt; checkTele tele
    <span class="hljs-type">PLabel</span> _ tele is ts -&gt; <span class="hljs-keyword">do</span>
      checkTele tele
      rho &lt;- asks env
      unless (all (`elem` is) (domain ts)) $
        throwError <span class="hljs-string">&quot;names in path label system&quot;</span> <span class="hljs-comment">-- TODO</span>
      mapM_ checkFresh is
      <span class="hljs-keyword">let</span> iis = zip is (map <span class="hljs-type">Atom</span> is)
      local (addSubs iis . addTele tele) $ <span class="hljs-keyword">do</span>
        checkSystemWith ts $ \alpha talpha -&gt;
          local (faceEnv alpha) $</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>NB: the type doesn’t depend on is</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            check (<span class="hljs-type">Ter</span> t rho) talpha
        rho&#x27; &lt;- asks env
        checkCompSystem (evalSystem rho&#x27; ts)
  (<span class="hljs-type">VPi</span> va@(<span class="hljs-type">Ter</span> (<span class="hljs-type">Sum</span> _ _ cas) nu) f,<span class="hljs-type">Split</span> _ _ ty ces) -&gt; <span class="hljs-keyword">do</span>
    check <span class="hljs-type">VU</span> ty
    rho &lt;- asks env
    unlessM (a === eval rho ty) $ throwError <span class="hljs-string">&quot;check: split annotations&quot;</span>
    <span class="hljs-keyword">if</span> map labelName cas == map branchName ces
       <span class="hljs-keyword">then</span> sequence_ [ checkBranch (lbl,nu) f brc (<span class="hljs-type">Ter</span> t rho) va
                      | (brc, lbl) &lt;- zip ces cas ]
       <span class="hljs-keyword">else</span> throwError <span class="hljs-string">&quot;case branches does not match the data type&quot;</span>
  (<span class="hljs-type">VPi</span> va@(<span class="hljs-type">Ter</span> (<span class="hljs-type">HSum</span> _ _ cas) nu) f,<span class="hljs-type">Split</span> _ _ ty ces) -&gt; <span class="hljs-keyword">do</span>
    check <span class="hljs-type">VU</span> ty
    rho &lt;- asks env
    unlessM (a === eval rho ty) $ throwError <span class="hljs-string">&quot;check: split annotations&quot;</span>
    <span class="hljs-keyword">if</span> map labelName cas == map branchName ces
       <span class="hljs-keyword">then</span> sequence_ [ checkBranch (lbl,nu) f brc (<span class="hljs-type">Ter</span> t rho) va
                      | (brc, lbl) &lt;- zip ces cas ]
       <span class="hljs-keyword">else</span> throwError <span class="hljs-string">&quot;case branches does not match the data type&quot;</span>
  (<span class="hljs-type">VPi</span> a f,<span class="hljs-type">Lam</span> x a&#x27; t)  -&gt; <span class="hljs-keyword">do</span>
    check <span class="hljs-type">VU</span> a&#x27;
    ns &lt;- asks names
    rho &lt;- asks env
    unlessM (a === eval rho a&#x27;) $
      throwError $ <span class="hljs-string">&quot;check: lam types don&#x27;t match&quot;</span>
        ++ <span class="hljs-string">&quot;\nlambda type annotation: &quot;</span> ++ show a&#x27;
        ++ <span class="hljs-string">&quot;\ndomain of Pi: &quot;</span> ++ show a
        ++ <span class="hljs-string">&quot;\nnormal form of type: &quot;</span> ++ show (normal ns a)
    <span class="hljs-keyword">let</span> var = mkVarNice ns x a

    local (addTypeVal (x,a)) $ check (app f var) t
  (<span class="hljs-type">VSigma</span> a f, <span class="hljs-type">Pair</span> t1 t2) -&gt; <span class="hljs-keyword">do</span>
    check a t1
    v &lt;- evalTyping t1
    check (app f v) t2
  (_,<span class="hljs-type">Where</span> e d) -&gt; <span class="hljs-keyword">do</span>
    local (\tenv@<span class="hljs-type">TEnv</span>{indent=i} -&gt; tenv{indent=i + <span class="hljs-number">2</span>}) $ checkDecls d
    local (addDecls d) $ check a e
  (<span class="hljs-type">VU</span>,<span class="hljs-type">PathP</span> a e0 e1) -&gt; <span class="hljs-keyword">do</span>
    (a0,a1) &lt;- checkPLam (constPath <span class="hljs-type">VU</span>) a
    check a0 e0
    check a1 e1
  (<span class="hljs-type">VPathP</span> p a0 a1,<span class="hljs-type">PLam</span> _ e) -&gt; <span class="hljs-keyword">do</span>
    (u0,u1) &lt;- checkPLam p t
    ns &lt;- asks names
    unless (conv ns a0 u0 &amp;&amp; conv ns a1 u1) $
      throwError $ <span class="hljs-string">&quot;path endpoints don&#x27;t match for &quot;</span> ++ show e ++ <span class="hljs-string">&quot;, got &quot;</span> ++
                   show (u0,u1) ++ <span class="hljs-string">&quot;, but expected &quot;</span> ++ show (a0,a1)
  (<span class="hljs-type">VU</span>,<span class="hljs-type">Glue</span> a ts) -&gt; <span class="hljs-keyword">do</span>
    check <span class="hljs-type">VU</span> a
    rho &lt;- asks env
    checkGlue (eval rho a) ts
  (<span class="hljs-type">VGlue</span> va ts,<span class="hljs-type">GlueElem</span> u us) -&gt; <span class="hljs-keyword">do</span>
    check va u
    vu &lt;- evalTyping u
    checkGlueElem vu ts us
  (<span class="hljs-type">VCompU</span> va ves,<span class="hljs-type">GlueElem</span> u us) -&gt; <span class="hljs-keyword">do</span>
    check va u
    vu &lt;- evalTyping u
    checkGlueElemU vu ves us
  (<span class="hljs-type">VU</span>,<span class="hljs-type">Id</span> a a0 a1) -&gt; <span class="hljs-keyword">do</span>
    check <span class="hljs-type">VU</span> a
    va &lt;- evalTyping a
    check va a0
    check va a1
  (<span class="hljs-type">VId</span> va va0 va1,<span class="hljs-type">IdPair</span> w ts) -&gt; <span class="hljs-keyword">do</span>
    check (<span class="hljs-type">VPathP</span> (constPath va) va0 va1) w
    vw &lt;- evalTyping w
    checkSystemWith ts $ \alpha tAlpha -&gt;
      local (faceEnv alpha) $ <span class="hljs-keyword">do</span>
        check (va `face` alpha) tAlpha
        vtAlpha &lt;- evalTyping tAlpha
        unlessM (vw `face` alpha === constPath vtAlpha) $
          throwError <span class="hljs-string">&quot;malformed eqC&quot;</span>
    rho &lt;- asks env
    checkCompSystem (evalSystem rho ts) <span class="hljs-comment">-- Not needed</span>
  _ -&gt; <span class="hljs-keyword">do</span>
    v &lt;- infer t
    unlessM (v === a) $
      throwError $ <span class="hljs-string">&quot;check conv:\n&quot;</span> ++ show v ++ <span class="hljs-string">&quot;\n/=\n&quot;</span> ++ show a</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p>Check a list of declarations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">checkDecls</span> :: <span class="hljs-type">Decls</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkDecls</span> (<span class="hljs-type">MutualDecls</span> _ []) = return ()
<span class="hljs-title">checkDecls</span> (<span class="hljs-type">MutualDecls</span> l d)  = <span class="hljs-keyword">do</span>
  a &lt;- asks env
  <span class="hljs-keyword">let</span> (idents,tele,ters) = (declIdents d,declTele d,declTers d)
  ind &lt;- asks indent
  trace (replicate ind &#x27; &#x27; ++ <span class="hljs-string">&quot;Checking: &quot;</span> ++ unwords idents)
  checkTele tele
  local (addDecls (<span class="hljs-type">MutualDecls</span> l d)) $ <span class="hljs-keyword">do</span>
    rho &lt;- asks env
    checks (tele,rho) ters
<span class="hljs-title">checkDecls</span> (<span class="hljs-type">OpaqueDecl</span> _)      = return ()
<span class="hljs-title">checkDecls</span> (<span class="hljs-type">TransparentDecl</span> _) = return ()
<span class="hljs-title">checkDecls</span> <span class="hljs-type">TransparentAllDecl</span>  = return ()</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>Check a telescope</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">checkTele</span> :: <span class="hljs-type">Tele</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkTele</span> []          = return ()
<span class="hljs-title">checkTele</span> ((x,a):xas) = <span class="hljs-keyword">do</span>
  check <span class="hljs-type">VU</span> a
  local (addType (x,a)) $ checkTele xas</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p>Check a family</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">checkFam</span> :: <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkFam</span> (<span class="hljs-type">Lam</span> x a b) = <span class="hljs-keyword">do</span>
  check <span class="hljs-type">VU</span> a
  local (addType (x,a)) $ check <span class="hljs-type">VU</span> b
<span class="hljs-title">checkFam</span> x = throwError $ <span class="hljs-string">&quot;checkFam: &quot;</span> ++ show x</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>Check that a system is compatible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">checkCompSystem</span> :: <span class="hljs-type">System</span> <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkCompSystem</span> vus = <span class="hljs-keyword">do</span>
  ns &lt;- asks names
  unless (isCompSystem ns vus)
    (throwError $ <span class="hljs-string">&quot;Incompatible system &quot;</span> ++ showSystem vus)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p>Check the values at corresponding faces with a function, assumes
systems have the same faces</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">checkSystemsWith</span> :: <span class="hljs-type">System</span> a -&gt; <span class="hljs-type">System</span> b -&gt; (<span class="hljs-type">Face</span> -&gt; a -&gt; b -&gt; <span class="hljs-type">Typing</span> c) -&gt;
                    <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkSystemsWith</span> us vs f = sequence_ $ elems $ intersectionWithKey f us vs</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>Check the faces of a system</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">checkSystemWith</span> :: <span class="hljs-type">System</span> a -&gt; (<span class="hljs-type">Face</span> -&gt; a -&gt; <span class="hljs-type">Typing</span> b) -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkSystemWith</span> us f = sequence_ $ elems $ mapWithKey f us</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>Check a glueElem</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">checkGlueElem</span> :: <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">System</span> <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">System</span> <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkGlueElem</span> vu ts us = <span class="hljs-keyword">do</span>
  unless (keys ts == keys us)
    (throwError (<span class="hljs-string">&quot;Keys don&#x27;t match in &quot;</span> ++ show ts ++ <span class="hljs-string">&quot; and &quot;</span> ++ show us))
  rho &lt;- asks env
  checkSystemsWith ts us
    (\alpha vt u -&gt; local (faceEnv alpha) $ check (equivDom vt) u)
  <span class="hljs-keyword">let</span> vus = evalSystem rho us
  checkSystemsWith ts vus (\alpha vt vAlpha -&gt;
    unlessM (app (equivFun vt) vAlpha === (vu `face` alpha)) $
      throwError $ <span class="hljs-string">&quot;Image of glue component &quot;</span> ++ show vAlpha ++
                   <span class="hljs-string">&quot; doesn&#x27;t match &quot;</span> ++ show vu)
  checkCompSystem vus</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p>Check a glueElem against VComp _ ves</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">checkGlueElemU</span> :: <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">System</span> <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">System</span> <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkGlueElemU</span> vu ves us = <span class="hljs-keyword">do</span>
  unless (keys ves == keys us)
    (throwError (<span class="hljs-string">&quot;Keys don&#x27;t match in &quot;</span> ++ show ves ++ <span class="hljs-string">&quot; and &quot;</span> ++ show us))
  rho &lt;- asks env
  checkSystemsWith ves us
    (\alpha ve u -&gt; local (faceEnv alpha) $ check (ve @@ <span class="hljs-type">One</span>) u)
  <span class="hljs-keyword">let</span> vus = evalSystem rho us
  checkSystemsWith ves vus (\alpha ve vAlpha -&gt;
    unlessM (eqFun ve vAlpha === (vu `face` alpha)) $
      throwError $ <span class="hljs-string">&quot;Transport of glueElem (for compU) component &quot;</span> ++ show vAlpha ++
                   <span class="hljs-string">&quot; doesn&#x27;t match &quot;</span> ++ show vu)
  checkCompSystem vus

<span class="hljs-title">checkGlue</span> :: <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">System</span> <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkGlue</span> va ts = <span class="hljs-keyword">do</span>
  checkSystemWith ts (\alpha tAlpha -&gt; checkEquiv (va `face` alpha) tAlpha)
  rho &lt;- asks env
  checkCompSystem (evalSystem rho ts)</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <p>An iso for a type b is a five-tuple: (a,f,g,s,t)   where
 a : U
 f : a -&gt; b
 g : b -&gt; a
 s : forall (y : b), f (g y) = y
 t : forall (x : a), g (f x) = x</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">mkIso</span> :: <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Val</span>
<span class="hljs-title">mkIso</span> vb = eval rho $
  <span class="hljs-type">Sigma</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;a&quot;</span> <span class="hljs-type">U</span> $
  <span class="hljs-type">Sigma</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;f&quot;</span> (<span class="hljs-type">Pi</span> (<span class="hljs-type">Lam</span> <span class="hljs-string">&quot;_&quot;</span> a b)) $
  <span class="hljs-type">Sigma</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;g&quot;</span> (<span class="hljs-type">Pi</span> (<span class="hljs-type">Lam</span> <span class="hljs-string">&quot;_&quot;</span> b a)) $
  <span class="hljs-type">Sigma</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;s&quot;</span> (<span class="hljs-type">Pi</span> (<span class="hljs-type">Lam</span> <span class="hljs-string">&quot;y&quot;</span> b $ <span class="hljs-type">PathP</span> (<span class="hljs-type">PLam</span> (<span class="hljs-type">Name</span> <span class="hljs-string">&quot;_&quot;</span>) b) (<span class="hljs-type">App</span> f (<span class="hljs-type">App</span> g y)) y)) $
    <span class="hljs-type">Pi</span> (<span class="hljs-type">Lam</span> <span class="hljs-string">&quot;x&quot;</span> a $ <span class="hljs-type">PathP</span> (<span class="hljs-type">PLam</span> (<span class="hljs-type">Name</span> <span class="hljs-string">&quot;_&quot;</span>) a) (<span class="hljs-type">App</span> g (<span class="hljs-type">App</span> f x)) x)
  <span class="hljs-keyword">where</span> [a,b,f,g,x,y] = map <span class="hljs-type">Var</span> [<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;f&quot;</span>,<span class="hljs-string">&quot;g&quot;</span>,<span class="hljs-string">&quot;x&quot;</span>,<span class="hljs-string">&quot;y&quot;</span>]
        rho = upd (<span class="hljs-string">&quot;b&quot;</span>,vb) emptyEnv</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p>An equivalence for a type a is a triple (t,f,p) where
t : U
f : t -&gt; a
p : (x : a) -&gt; isContr ((y:t) * Id a x (f y))
with isContr c = (z : c) * ((z’ : C) -&gt; Id c z z’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">mkEquiv</span> :: <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Val</span>
<span class="hljs-title">mkEquiv</span> va = eval rho $
  <span class="hljs-type">Sigma</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;t&quot;</span> <span class="hljs-type">U</span> $
  <span class="hljs-type">Sigma</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;f&quot;</span> (<span class="hljs-type">Pi</span> (<span class="hljs-type">Lam</span> <span class="hljs-string">&quot;_&quot;</span> t a)) $
  <span class="hljs-type">Pi</span> (<span class="hljs-type">Lam</span> <span class="hljs-string">&quot;x&quot;</span> a $ iscontrfib)
  <span class="hljs-keyword">where</span> [a,b,f,x,y,s,t,z] = map <span class="hljs-type">Var</span> [<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;f&quot;</span>,<span class="hljs-string">&quot;x&quot;</span>,<span class="hljs-string">&quot;y&quot;</span>,<span class="hljs-string">&quot;s&quot;</span>,<span class="hljs-string">&quot;t&quot;</span>,<span class="hljs-string">&quot;z&quot;</span>]
        rho = upd (<span class="hljs-string">&quot;a&quot;</span>,va) emptyEnv
        fib = <span class="hljs-type">Sigma</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;y&quot;</span> t (<span class="hljs-type">PathP</span> (<span class="hljs-type">PLam</span> (<span class="hljs-type">Name</span> <span class="hljs-string">&quot;_&quot;</span>) a) x (<span class="hljs-type">App</span> f y))
        iscontrfib = <span class="hljs-type">Sigma</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;s&quot;</span> fib $
                     <span class="hljs-type">Pi</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;z&quot;</span> fib $ <span class="hljs-type">PathP</span> (<span class="hljs-type">PLam</span> (<span class="hljs-type">Name</span> <span class="hljs-string">&quot;_&quot;</span>) fib) s z

<span class="hljs-title">checkEquiv</span> :: <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkEquiv</span> va equiv = check (mkEquiv va) equiv

<span class="hljs-title">checkIso</span> :: <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkIso</span> vb iso = check (mkIso vb) iso

<span class="hljs-title">checkBranch</span> :: (<span class="hljs-type">Label</span>,<span class="hljs-type">Env</span>) -&gt; <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Branch</span> -&gt; <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkBranch</span> (<span class="hljs-type">OLabel</span> _ tele,nu) f (<span class="hljs-type">OBranch</span> c ns e) _ _ = <span class="hljs-keyword">do</span>
  ns&#x27; &lt;- asks names
  <span class="hljs-keyword">let</span> us = map snd $ mkVars ns&#x27; tele nu
  local (addBranch (zip ns us) nu) $ check (app f (<span class="hljs-type">VCon</span> c us)) e
<span class="hljs-title">checkBranch</span> (<span class="hljs-type">PLabel</span> _ tele is ts,nu) f (<span class="hljs-type">PBranch</span> c ns js e) g va = <span class="hljs-keyword">do</span>
  ns&#x27; &lt;- asks names</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <p>mapM_ checkFresh js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">let</span> us   = mkVars ns&#x27; tele nu
      vus  = map snd us
      js&#x27;  = map <span class="hljs-type">Atom</span> js
      vts  = evalSystem (subs (zip is js&#x27;) (upds us nu)) ts
      vgts = intersectionWith app (border g vts) vts
  local (addSubs (zip js js&#x27;) . addBranch (zip ns vus) nu) $ <span class="hljs-keyword">do</span>
    check (app f (<span class="hljs-type">VPCon</span> c va vus js&#x27;)) e
    ve  &lt;- evalTyping e <span class="hljs-comment">-- <span class="hljs-doctag">TODO:</span> combine with next two lines?</span>
    <span class="hljs-keyword">let</span> veborder = border ve vts
    unlessM (veborder === vgts) $
      throwError $ <span class="hljs-string">&quot;Faces in branch for &quot;</span> ++ show c ++ <span class="hljs-string">&quot; don&#x27;t match:&quot;</span>
                   ++ <span class="hljs-string">&quot;\ngot\n&quot;</span> ++ showSystem veborder ++ <span class="hljs-string">&quot;\nbut expected\n&quot;</span>
                   ++ showSystem vgts

<span class="hljs-title">checkFormula</span> :: <span class="hljs-type">Formula</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkFormula</span> phi = <span class="hljs-keyword">do</span>
  rho &lt;- asks env
  <span class="hljs-keyword">let</span> dom = domainEnv rho
  unless (all (`elem` dom) (support phi)) $
    throwError $ <span class="hljs-string">&quot;checkFormula: &quot;</span> ++ show phi

<span class="hljs-title">checkFresh</span> :: <span class="hljs-type">Name</span> -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checkFresh</span> i = <span class="hljs-keyword">do</span>
  rho &lt;- asks env
  when (i `elem` support rho)
    (throwError $ show i ++ <span class="hljs-string">&quot; is already declared&quot;</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p>Check that a term is a PLam and output the source and target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">checkPLam</span> :: <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> (<span class="hljs-type">Val</span>,<span class="hljs-type">Val</span>)
<span class="hljs-title">checkPLam</span> v (<span class="hljs-type">PLam</span> i a) = <span class="hljs-keyword">do</span>
  rho &lt;- asks env</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-27">&#x00a7;</a>
              </div>
              <p>checkFresh i</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  local (addSub (i,<span class="hljs-type">Atom</span> i)) $ check (v @@ i) a
  return (eval (sub (i,<span class="hljs-type">Dir</span> <span class="hljs-number">0</span>) rho) a,eval (sub (i,<span class="hljs-type">Dir</span> <span class="hljs-number">1</span>) rho) a)
<span class="hljs-title">checkPLam</span> v t = <span class="hljs-keyword">do</span>
  vt &lt;- infer t
  <span class="hljs-keyword">case</span> vt <span class="hljs-keyword">of</span>
    <span class="hljs-type">VPathP</span> a a0 a1 -&gt; <span class="hljs-keyword">do</span>
      unlessM (a === v) $ throwError (
        <span class="hljs-string">&quot;checkPLam\n&quot;</span> ++ show v ++ <span class="hljs-string">&quot;\n/=\n&quot;</span> ++ show a)
      return (a0,a1)
    _ -&gt; throwError $ show vt ++ <span class="hljs-string">&quot; is not a path&quot;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-28">&#x00a7;</a>
              </div>
              <p>Return system such that:
  rhoalpha |- p_alpha : Id (va alpha) (t0 rhoalpha) ualpha
Moreover, check that the system ps is compatible.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">checkPLamSystem</span> :: <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Val</span> -&gt; <span class="hljs-type">System</span> <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> (<span class="hljs-type">System</span> <span class="hljs-type">Val</span>)
<span class="hljs-title">checkPLamSystem</span> t0 va ps = <span class="hljs-keyword">do</span>
  rho &lt;- asks env
  v &lt;- <span class="hljs-type">T</span>.sequence $ mapWithKey (\alpha pAlpha -&gt;
    local (faceEnv alpha) $ <span class="hljs-keyword">do</span>
      rhoAlpha &lt;- asks env
      (a0,a1)  &lt;- checkPLam (va `face` alpha) pAlpha
      unlessM (a0 === eval rhoAlpha t0) $
        throwError $ <span class="hljs-string">&quot;Incompatible system &quot;</span> ++ showSystem ps ++
                     <span class="hljs-string">&quot;, component\n &quot;</span> ++ show pAlpha ++
                     <span class="hljs-string">&quot;\nincompatible with\n &quot;</span> ++ show t0 ++
                     <span class="hljs-string">&quot;\na0 = &quot;</span> ++ show a0 ++
                     <span class="hljs-string">&quot;\nt0alpha = &quot;</span> ++ show (eval rhoAlpha t0) ++
                     <span class="hljs-string">&quot;\nva = &quot;</span> ++ show va
      return a1) ps
  checkCompSystem (evalSystem rho ps)
  return v

<span class="hljs-title">checks</span> :: (<span class="hljs-type">Tele</span>,<span class="hljs-type">Env</span>) -&gt; [<span class="hljs-type">Ter</span>] -&gt; <span class="hljs-type">Typing</span> ()
<span class="hljs-title">checks</span> ([],_)         []     = return ()
<span class="hljs-title">checks</span> ((x,a):xas,nu) (e:es) = <span class="hljs-keyword">do</span>
  check (eval nu a) e
  v&#x27; &lt;- evalTyping e
  checks (xas,upd (x,v&#x27;) nu) es
<span class="hljs-title">checks</span> _              _      =
  throwError <span class="hljs-string">&quot;checks: incorrect number of arguments&quot;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-29">&#x00a7;</a>
              </div>
              <p>infer the type of e</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-title">infer</span> :: <span class="hljs-type">Ter</span> -&gt; <span class="hljs-type">Typing</span> <span class="hljs-type">Val</span>
<span class="hljs-title">infer</span> e = <span class="hljs-keyword">case</span> e <span class="hljs-keyword">of</span>
  <span class="hljs-type">U</span>           -&gt; return <span class="hljs-type">VU</span>  <span class="hljs-comment">-- U : U</span>
  <span class="hljs-type">Var</span> n       -&gt; lookType n &lt;$&gt; asks env
  <span class="hljs-type">App</span> t u -&gt; <span class="hljs-keyword">do</span>
    c &lt;- infer t
    <span class="hljs-keyword">case</span> c <span class="hljs-keyword">of</span>
      <span class="hljs-type">VPi</span> a f -&gt; <span class="hljs-keyword">do</span>
        check a u
        v &lt;- evalTyping u
        return $ app f v
      _       -&gt; throwError $ show c ++ <span class="hljs-string">&quot; is not a product&quot;</span>
  <span class="hljs-type">Fst</span> t -&gt; <span class="hljs-keyword">do</span>
    c &lt;- infer t
    <span class="hljs-keyword">case</span> c <span class="hljs-keyword">of</span>
      <span class="hljs-type">VSigma</span> a f -&gt; return a
      _          -&gt; throwError $ show c ++ <span class="hljs-string">&quot; is not a sigma-type&quot;</span>
  <span class="hljs-type">Snd</span> t -&gt; <span class="hljs-keyword">do</span>
    c &lt;- infer t
    <span class="hljs-keyword">case</span> c <span class="hljs-keyword">of</span>
      <span class="hljs-type">VSigma</span> a f -&gt; <span class="hljs-keyword">do</span>
        v &lt;- evalTyping t
        return $ app f (fstVal v)
      _          -&gt; throwError $ show c ++ <span class="hljs-string">&quot; is not a sigma-type&quot;</span>
  <span class="hljs-type">Where</span> t d -&gt; <span class="hljs-keyword">do</span>
    checkDecls d
    local (addDecls d) $ infer t
  <span class="hljs-type">UnGlueElem</span> e _ -&gt; <span class="hljs-keyword">do</span>
    t &lt;- infer e
    <span class="hljs-keyword">case</span> t <span class="hljs-keyword">of</span>
     <span class="hljs-type">VGlue</span> a _ -&gt; return a
     _ -&gt; throwError (show t ++ <span class="hljs-string">&quot; is not a Glue&quot;</span>)
  <span class="hljs-type">AppFormula</span> e phi -&gt; <span class="hljs-keyword">do</span>
    checkFormula phi
    t &lt;- infer e
    <span class="hljs-keyword">case</span> t <span class="hljs-keyword">of</span>
      <span class="hljs-type">VPathP</span> a _ _ -&gt; return $ a @@ phi
      _ -&gt; throwError (show e ++ <span class="hljs-string">&quot; is not a path&quot;</span>)
  <span class="hljs-type">Comp</span> a t0 ps -&gt; <span class="hljs-keyword">do</span>
    (va0, va1) &lt;- checkPLam (constPath <span class="hljs-type">VU</span>) a
    va &lt;- evalTyping a
    check va0 t0
    checkPLamSystem t0 va ps
    return va1
  <span class="hljs-type">HComp</span> a u0 us -&gt; <span class="hljs-keyword">do</span>
    check <span class="hljs-type">VU</span> a
    va &lt;- evalTyping a
    check va u0
    checkPLamSystem u0 (constPath va) us
    return va
  <span class="hljs-type">Fill</span> a t0 ps -&gt; <span class="hljs-keyword">do</span>
    (va0, va1) &lt;- checkPLam (constPath <span class="hljs-type">VU</span>) a
    va &lt;- evalTyping a
    check va0 t0
    checkPLamSystem t0 va ps
    vt  &lt;- evalTyping t0
    rho &lt;- asks env
    <span class="hljs-keyword">let</span> vps = evalSystem rho ps
    return (<span class="hljs-type">VPathP</span> va vt (compLine va vt vps))
  <span class="hljs-type">PCon</span> c a es phis -&gt; <span class="hljs-keyword">do</span>
    check <span class="hljs-type">VU</span> a
    va &lt;- evalTyping a
    (bs,nu) &lt;- getLblType c va
    checks (bs,nu) es
    mapM_ checkFormula phis
    return va
  <span class="hljs-type">IdJ</span> a u c d x p -&gt; <span class="hljs-keyword">do</span>
    check <span class="hljs-type">VU</span> a
    va &lt;- evalTyping a
    check va u
    vu &lt;- evalTyping u
    <span class="hljs-keyword">let</span> refu = <span class="hljs-type">VIdPair</span> (constPath vu) $ mkSystem [(eps,vu)]
    rho &lt;- asks env
    <span class="hljs-keyword">let</span> z = <span class="hljs-type">Var</span> <span class="hljs-string">&quot;z&quot;</span>
        ctype = eval rho $ <span class="hljs-type">Pi</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;z&quot;</span> a $ <span class="hljs-type">Pi</span> $ <span class="hljs-type">Lam</span> <span class="hljs-string">&quot;_&quot;</span> (<span class="hljs-type">Id</span> a u z) <span class="hljs-type">U</span>
    check ctype c
    vc &lt;- evalTyping c
    check (app (app vc vu) refu) d
    check va x
    vx &lt;- evalTyping x
    check (<span class="hljs-type">VId</span> va vu vx) p
    vp &lt;- evalTyping p
    return (app (app vc vx) vp)
  _ -&gt; throwError (<span class="hljs-string">&quot;infer &quot;</span> ++ show e)</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-30">&#x00a7;</a>
              </div>
              <p>Not used since we have U : U</p>
<p>(=?=) :: Typing Ter -&gt; Ter -&gt; Typing ()
m =?= s2 = do
  s1 &lt;- m
  unless (s1 == s2) $ throwError (show s1 ++ “ =/= “ ++ show s2)</p>
<p>checkTs :: [(String,Ter)] -&gt; Typing ()
checkTs [] = return ()
checkTs ((x,a):xas) = do
  checkType a
  local (addType (x,a)) (checkTs xas)</p>
<p>checkType :: Ter -&gt; Typing ()
checkType t = case t of
  U              -&gt; return ()
  Pi a (Lam x b) -&gt; do
    checkType a
    local (addType (x,a)) (checkType b)
  _ -&gt; infer t =?= U</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
